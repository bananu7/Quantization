<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <title>Image quantization project</title>
    <script type="text/javascript" src="dithering/common.js"></script>
    <script type="text/javascript">
        var img;
        var magnifierEnabled = false;
        var magnifierZoom = 2;

        function handleFileSelect(evt) {
            var files = evt.target.files; // FileList object

            // files is a FileList of File objects. List some properties.
            img.src = URL.createObjectURL(files[0]);
        }

        function getSelectedRadio(radioElemName) {
            var radios = document.getElementsByName(radioElemName);
            var value;
            for (var i = 0; i < radios.length; ++i) {
                if (radios[i].checked) {
                    return radios[i].value;
                }
            }
            return undefined;
        }

        function process() {
            var ctx = document.getElementById('canvas').getContext('2d');
            var imdata = ctx.getImageData(0, 0, 500, 500);

            // Palette construction
            var paletteAlgorithm = getSelectedRadio('paletteS');
            var paletteWorker = new Worker("palette/" + paletteAlgorithm + ".js");
            paletteWorker.onmessage = function (evt) {
                if (evt.data.type == "progress") {
                    document.getElementById('progressbar').style.width = (evt.data.val * 5) +'px';
                } else if (evt.data.type == "finished") {
                    // Actual image quantization
                    var palette = evt.data.palette;

                    var algorithm = getSelectedRadio('algorithmS');
                    if (algorithm === undefined) throw "wrong algorithm picked";

                    var myWorker = new Worker("dithering/" + algorithm + ".js");
                    
                    // reset the progressbar
                    document.getElementById('progressbar').style.width = 0;

                    myWorker.onmessage = function (oEvent) {
                        //alert("event");
                        if (oEvent.data.type == "progress") {
                            document.getElementById('progressbar').style.width = (oEvent.data.val * 5) +'px';
                            //console.log("Called back by the worker!\n");
                        } else if (oEvent.data.type == "finished") {
                            document.getElementById('progressbar').style.width = (502) +'px';
                            ctx.putImageData(oEvent.data.imdata, 0, 0);
                        }
                    };

                    myWorker.postMessage({
                        imdata: imdata,
                        palette: palette
                    });
                }
            }
            paletteWorker.postMessage(imdata);
        }

        function toggleMagnifier() { 
            magnifierEnabled = !magnifierEnabled;
            document.getElementById('magnifier').style.display = magnifierEnabled ? "" : "none";
        }
        function setMagnifierZoom(zoom) { 
            document.getElementById('magnifierZoomDisplay').innerHTML = zoom + "x";
            magnifierZoom = zoom;
        }

        function preloader() {
            img = new Image();   // Create new img element
            img.addEventListener("load", function() {
                //document.getElementById("pick-algorithm").disabled = false;
                var ctx = document.getElementById('canvas').getContext('2d');
                ctx.drawImage(img,0,0);
            }, false);

            img.src = 'pizza.jpg';
            document.getElementById('files').addEventListener('change', handleFileSelect, false);
            document.getElementById('canvas').addEventListener('mouseout', function() {
                if (magnifierEnabled)
                    document.getElementById('magnifier').style.display = "none";
            });
            document.getElementById('canvas').addEventListener('mouseover', function() {
                if (magnifierEnabled)
                    document.getElementById('magnifier').style.display = "";
            });

            document.getElementById('canvas').addEventListener('mousemove', function(event) {
                if (!magnifierEnabled)
                    return;

                var magnifier = document.getElementById('magnifier');
                magnifier.style.left = (event.clientX - 100) + "px";
                magnifier.style.top = (event.clientY - 100) + "px";

                var ctx = document.getElementById('canvas').getContext('2d');
                var origImdata = ctx.getImageData(0, 0, 500, 500);
                var offset = { x: event.offsetX, y: event.offsetY };

                var magnCtx =  document.getElementById('magnCanvas').getContext('2d');
                var imdata = magnCtx.getImageData(0, 0, 200, 200);
                magnCtx.beginPath();
                magnCtx.rect(0,0,200,200);
                magnCtx.fill();

                var zoom = magnifierZoom;
                for (var y = 0; y < 200 / zoom; y++) {
                    for (var x = 0; x < 200 / zoom; x++) {
                        var c = getPixelFromImdata(origImdata, x + offset.x, y + offset.y);                        

                        var xx = x*zoom;
                        var yy = y*zoom;

                        for (var iy = 0; iy < zoom; iy++) {    
                            for (var ix = 0; ix < zoom; ix++) {
                                setPixelAtImdata(imdata, xx+ix, yy+iy, c);
                            }
                        }
                    }
                }
                magnCtx.putImageData(imdata, 0, 0);
            });
        }
    </script>
    <style type="text/css">
        #magnifier {
            width: 200px;
            height: 200px;
            border-radius:100px;
            z-index: 100;
            border: 1px solid white;
            position: absolute;
            pointer-events: none;
            overflow: hidden;
        }
        #magnCanvas { width: 200px; height: 200px; }

        .optionBlock { min-width: 300px; min-height: 100px; float: left; margin 0px 0px 10px 10px; }
    </style>
</head>

<body onLoad="preloader()">
    <h1>Image Quantization</h1>
    <h2>Visualization of Information - Gdańsk University of Technology 2013</h2>
    <h3><em>Bartosz Banachewicz & Michał Wierzbicki</em></h3>
    <p>The code is available under MIT licence.</p>
    <form>
        <fieldset id="pick-file">
            <input type="file" id="files" name="files[]" multiple />
        </fieldset>
    </form>
    <form>
        <fieldset id="pick-pallette-builder" class="optionBlock">
            <span>Choose palette building algorithm:</span><br>
            <input type="radio" name="paletteS" value="regular">Regular divisions<br>
            <input type="radio" name="paletteS" value="octree" checked>Octree-based numbered<br>
        </fieldset>

        <fieldset id="pick-dithering" class="optionBlock">
            <span>Choose algorithm file:</span><br>
            <input type="radio" name="algorithmS" value="negate">Misc. - negate the image<br>
            <input type="radio" name="algorithmS" value="Simple-Threshold">Simple threshold<br>
            <input type="radio" name="algorithmS" value="Floyd-Steinberg" checked>Floyd-Steinberg<br>            
        </fieldset>

        <fieldset class="optionBlock">
            <span>Options</span><br>
            <input type="checkbox" onchange="toggleMagnifier()">Magnifier<br>
            Zoom<input type="range" min="2" max="12" onchange="setMagnifierZoom(this.value)" value="2"><span id="magnifierZoomDisplay">2x</span>
        </fieldset>

        <input type="button" onclick="process()" value="Process">
    </form>

    <br style="clear: both;">

    <canvas id="canvas" width="500" height="500" style="width: 500px; height: 500px; border: 1px solid black;"></canvas>
    <div id="progressbar" style="height: 100px; background-color: green; width: 0;"></div>
    <div id="magnifier">
        <canvas id="magnCanvas" width="200" height="200"></canvas>
    </div>
</body>

</html>

